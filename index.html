<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengecekan Hasil Verifikasi Pengurangan Tarif Uang Kuliah Pascasarjana ULM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #ffffff;
            min-height: 100vh;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .header-table td {
            border: none;
            vertical-align: middle;
        }
        .header-table img {
            max-width: 150px;
            height: auto;
        }
        /* Menghilangkan spinners pada input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Styling untuk loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay untuk Halaman -->
    <div id="pageLoading" class="loading-overlay">
        <div class="spinner-border text-primary loading-spinner" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Header with Logo and Text -->
                <table class="header-table mb-4 w-100">
                    <tr>
                        <td class="text-start">
                            <img src="lambangULM2021warna.jpg" alt="Logo Universitas Lambung Mangkurat">
                        </td>
                        <td class="text-center">
                            <h2>Hasil Verifikasi Pengurangan Tarif Uang Kuliah</h2>
                            <h4>Untuk Jenjang Magister dan Doktor</h4>
                            <h4>Universitas Lambung Mangkurat Tahun 2025</h4>
                        </td>
                    </tr>
                </table>

                <!-- Section Pengecekan dengan Tabs -->
                <div id="checkSection" class="card p-4">
                    <h3 class="text-center mb-4">Pengecekan Hasil Verifikasi Pengurangan Tarif Uang Kuliah</h3>
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="baru-tab" data-bs-toggle="tab" data-bs-target="#baru" type="button" role="tab" aria-controls="baru" aria-selected="true">Mahasiswa Baru</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="lama-tab" data-bs-toggle="tab" data-bs-target="#lama" type="button" role="tab" aria-controls="lama" aria-selected="false">Mahasiswa Lama</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="myTabContent">
                        <!-- Tab Mahasiswa Baru -->
                        <div class="tab-pane fade show active" id="baru" role="tabpanel" aria-labelledby="baru-tab">
                            <form id="checkFormBaru">
                                <div class="mb-3">
                                    <label for="noRegistrasi" class="form-label">No Registrasi (11 digit angka)</label>
                                    <input type="number" class="form-control" id="noRegistrasi" required>
                                </div>
                                <div class="mb-3">
                                    <label for="captchaBaru" class="form-label">CAPTCHA: <span id="captchaQuestionBaru"></span></label>
                                    <input type="number" class="form-control" id="captchaBaru" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Cek</button>
                            </form>
                        </div>
                        <!-- Tab Mahasiswa Lama -->
                        <div class="tab-pane fade" id="lama" role="tabpanel" aria-labelledby="lama-tab">
                            <form id="checkFormLama">
                                <div class="mb-3">
                                    <label for="nim" class="form-label">NIM (13 digit angka)</label>
                                    <input type="number" class="form-control" id="nim" required>
                                </div>
                                <div class="mb-3">
                                    <label for="captchaLama" class="form-label">CAPTCHA: <span id="captchaQuestionLama"></span></label>
                                    <input type="number" class="form-control" id="captchaLama" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Cek</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Hasil Output (hidden awalnya) -->
                <div id="resultSection" class="card p-4 d-none">
                    <h3 class="text-center mb-4">Hasil Verifikasi</h3>
                    <table class="table table-bordered">
                        <tr><th>No Registrasi / NIM</th><td id="resId"></td></tr>
                        <tr id="resNamaRow"><th>Nama</th><td id="resNama"></td></tr>
                        <tr id="resProdiRow"><th>Program Studi</th><td id="resProdi"></td></tr>
                        <tr id="resKategoriRow"><th>Kategori</th><td id="resKategori"></td></tr>
                        <tr id="resVerifikasiRow"><th>Hasil Verifikasi</th><td id="resVerifikasi"></td></tr>
                        <tr id="resAlasanRow" class="d-none"><th>Alasan</th><td id="resAlasan" class="text-danger"></td></tr>
                    </table>
                    <button id="backBtn" class="btn btn-secondary w-100 mt-3">Kembali</button>
                </div>
            </div>
        </div>
    </div>

     <!-- Loading Overlay untuk Cek Data -->
    <div id="dataLoading" class="loading-overlay d-none">
        <div class="spinner-border text-primary loading-spinner" role="status">
            <span class="visually-hidden">Memproses...</span>
        </div>
    </div>

    <script>
        // Nonaktifkan klik kanan
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Sembunyikan loading awal setelah halaman siap
        $(document).ready(function() {
            $('#pageLoading').fadeOut(500);
        });

        // Fungsi untuk generate CAPTCHA
        function generateCaptcha(questionId, inputId) {
            let captchaA = Math.floor(Math.random() * 10) + 1;
            let captchaB = Math.floor(Math.random() * 10) + 1;
            let captchaAnswer = captchaA + captchaB;
            $('#' + questionId).text(captchaA + ' + ' + captchaB + ' = ?');
            return captchaAnswer;
        }

        // Inisialisasi CAPTCHA untuk kedua tab
        let captchaAnswerBaru = generateCaptcha('captchaQuestionBaru', 'captchaBaru');
        let captchaAnswerLama = generateCaptcha('captchaQuestionLama', 'captchaLama');

        // Fungsi validasi input hanya angka dan panjang tertentu
        function validateInput(input, length, label) {
            const regex = /^\d+$/;
            if (!regex.test(input)) {
                alert(`${label} harus berisi angka saja!`);
                return false;
            }
            if (input.length !== length) {
                alert(`${label} harus terdiri dari ${length} digit!`);
                return false;
            }
            return true;
        }

        // Fungsi untuk menampilkan hasil verifikasi
        function showResult(result, id, isBaru) {
            $('#resId').text(id);
            if (result.error) {
                $('#resNamaRow').addClass('d-none');
                $('#resProdiRow').addClass('d-none');
                $('#resKategoriRow').addClass('d-none');
                $('#resVerifikasiRow').addClass('d-none');
                $('#resAlasanRow').removeClass('d-none');
                $('#resAlasan').text(result.error);
            } else {
                $('#resNama').text(result.nama);
                $('#resProdi').text(result.program_studi);
                $('#resKategori').text(result.kategori);
                $('#resNamaRow').removeClass('d-none');
                $('#resProdiRow').removeClass('d-none');
                $('#resKategoriRow').removeClass('d-none');
                $('#resVerifikasiRow').removeClass('d-none');
                
                const verifikasi = result.hasil_verifikasi;
                if (verifikasi.startsWith("Memenuhi")) {
                    $('#resVerifikasi').html('<span class="fs-4 text-success">' + verifikasi + '</span>');
                    $('#resAlasanRow').addClass('d-none');
                } else if (verifikasi.startsWith("Tidak Memenuhi")) {
                    $('#resVerifikasi').html('<span class="fs-4 text-danger">' + verifikasi + '</span>');
                    $('#resAlasan').text(result.alasan);
                    $('#resAlasanRow').removeClass('d-none');
                } else {
                    $('#resVerifikasi').html('<span class="fs-4">' + verifikasi + '</span>');
                    $('#resAlasanRow').addClass('d-none');
                }
            }
            
            $('#dataLoading').addClass('d-none');
            $('#checkSection').addClass('d-none');
            $('#resultSection').removeClass('d-none');
        }

        // Handle form submit Mahasiswa Baru
        $('#checkFormBaru').submit(function(e) {
            e.preventDefault();
            
            const noReg = $('#noRegistrasi').val();
            // Validasi No Registrasi
            if (!validateInput(noReg, 11, 'No Registrasi')) {
                return;
            }
            
            const userCaptcha = parseInt($('#captchaBaru').val());
            if (userCaptcha !== captchaAnswerBaru) {
                alert('CAPTCHA salah!');
                return;
            }
            
            // Tampilkan loading
            $('#dataLoading').removeClass('d-none');
            
            // Kirim permintaan ke API dengan delay 2 detik
            setTimeout(function() {
                $.ajax({
                    url: 'https://pps-ulm.inovasidigital.link/api/check_baru.php',
                    type: 'POST',
                    data: { no_registrasi: noReg },
                    dataType: 'json',
                    success: function(response) {
                        showResult(response, noReg, true);
                    },
                    error: function(xhr, status, error) {
                        showResult({ error: 'Gagal menghubungi server: ' + error }, noReg, true);
                    }
                });
            }, 2000);
        });

        // Handle form submit Mahasiswa Lama
        $('#checkFormLama').submit(function(e) {
            e.preventDefault();
            
            const nim = $('#nim').val();
            // Validasi NIM
            if (!validateInput(nim, 13, 'NIM')) {
                return;
            }
            
            const userCaptcha = parseInt($('#captchaLama').val());
            if (userCaptcha !== captchaAnswerLama) {
                alert('CAPTCHA salah!');
                return;
            }
            
            // Tampilkan loading
            $('#dataLoading').removeClass('d-none');
            
            // Kirim permintaan ke API dengan delay 2 detik
            setTimeout(function() {
                $.ajax({
                    url: 'https://pps-ulm.inovasidigital.link/api/check_lama.php',
                    type: 'POST',
                    data: { nim: nim },
                    dataType: 'json',
                    success: function(response) {
                        showResult(response, nim, false);
                    },
                    error: function(xhr, status, error) {
                        showResult({ error: 'Gagal menghubungi server: ' + error }, nim, false);
                    }
                });
            }, 2000);
        });

        // Handle tombol kembali
        $('#backBtn').click(function() {
            $('#checkSection').removeClass('d-none');
            $('#resultSection').addClass('d-none');
            $('#checkFormBaru')[0].reset();
            $('#checkFormLama')[0].reset();
            captchaAnswerBaru = generateCaptcha('captchaQuestionBaru', 'captchaBaru');
            captchaAnswerLama = generateCaptcha('captchaQuestionLama', 'captchaLama');
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
